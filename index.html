<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Audio Player</title>
    <script src="getFiles.php"></script>
    <script src="getConfig.php"></script>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background-color: lightgrey;
        }

        p {
            margin: 0;
        }

        #audio-container {
            display: grid;
            grid-template-columns: repeat(6, 16.5%);
            /* grid-auto-rows: 100px; */
            /* grid-template-columns: 25% 25% 25% 25%; */
            grid-gap: 2px;

            padding: 0.2em;
            padding-right: 0.6em;

        }

        .audio-label {
            margin-left: 2px;
            text-overflow: ellipsis;
            font-size: 100%;
            overflow: hidden;
            font-weight: bold;
            color: white;
            font-family: monospace;
            white-space: nowrap;
        }

        .statusDiv {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: red;
            display: inline-block;
            margin-right: 2px;
        }

        .audio-time {
            color: pink;
            margin-left: 10px;
            display: inline-block;
            font-family: monospace;
        }


        .audio-vol {
            color: pink;
            margin-left: 10px;
            display: inline-block;
            font-family: monospace;
        }

        .audio-reset {
            background-color: darkred;
            border: 0px;
            border-radius: 30%;
            color: white;
            position: absolute;
            bottom: 0;
            right: 0;
            margin-right: 2px;
            margin-bottom: 2px;
        }

        .audio-tags {
            font-size: 70%;
            color: #a6a6a6;
            font-family: monospace;
            font-style: italic;
        }

        .audio-pause {
            background-color: lightpink;
            border: 0px;
            border-radius: 30%;
            color: white;
            position: absolute;
            bottom: 0;
            right: 6em;
            margin-right: 2px;
            margin-bottom: 2px;
        }

        .audio-up {
            background-color: gray;
            border: 0px;
            border-radius: 30%;
            color: white;
            position: absolute;
            bottom: 0;
            right: 4em;
            margin-right: 2px;
            margin-bottom: 2px;
        }

        .audio-down {
            background-color: gray;
            border: 0px;
            border-radius: 30%;
            color: white;
            position: absolute;
            bottom: 0;
            right: 2em;
            margin-right: 2px;
            margin-bottom: 2px;
        }

        .audio-block {
            align-items: center;
            padding: 0.2em;
            /* height: 3em; */
            /* background-color: #4646fc; */
            position: relative;
        }

        .audio-player {
            min-width: 30%;
        }

        #audio-top {
            padding: 0.1em;
            width: 100%;
            background: gray;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 130%;
            font-family: monospace;
            color: white;
        }

        #config-loaded {
            position: absolute;
            height: 20px;
            width: 20px;
            background: red;
            border-radius: 50%;
        }
    </style>
    <script>
        const COMBAT_TAG = "combat";
        const LIGHT_BLUE = "#4646fc";
        const DARK_BLUE = "#00008b";
        const LIGHT_COMBAT = "#b84747";
        const DARK_COMBAT = "#5b0202";

        var currentPlayingId = null;
        var currentPlayingObj = null;

        //Utility
        function downloadObjectAsJson(exportObj, exportName) {
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function generateConfig() {
            var out = [];
            files.forEach(sing => {
                console.log(sing);
                var obj = {
                    "file": sing,
                    "tags": [],
                    "displayName": sing
                }
                out.push(obj)
            })
            downloadObjectAsJson(out, "test");
        }

        function percentage(partialValue, totalValue) {
            return (100 * partialValue) / totalValue;
        }

        function currentTimeStamp(current) {
            return Math.round(current * 10) / 10; //round to 1 decimal place
        }

        function stopPlayWithConfig(obj) {
            document.getElementById(obj.file).pause();
            document.getElementById(obj.file).currentTime = 0;
            if (obj.tags.includes(COMBAT_TAG)) {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = LIGHT_COMBAT;
            } else {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = LIGHT_BLUE;
            }
        }

        function pausePlayWithConfig(obj) {
            document.getElementById(obj.file).pause();
            if (obj.tags.includes(COMBAT_TAG)) {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = LIGHT_COMBAT;
            } else {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = LIGHT_BLUE;
            }
        }

        function stopPlay(id) {
            document.getElementById(id).pause();
            document.getElementById(id).currentTime = 0;
            document.getElementById(`${id}-block`).style.backgroundColor = LIGHT_BLUE;
        }

        function pausePlay(id) {
            document.getElementById(id).pause();
            document.getElementById(`${id}-block`).style.backgroundColor = LIGHT_BLUE;
        }

        function upVolume(id) {
            if (parseFloat(document.getElementById(id).volume) < 1) {
                var vol = document.getElementById(id).volume;
                currentVolume = Math.round((vol + 0.1) * 10) / 10;
                document.getElementById(id).volume = currentVolume;
                document.getElementById(id + "-vol").innerHTML = currentVolume;
            }
        }

        function downVolume(id) {
            if (parseFloat(document.getElementById(id).volume) > 0) {
                var vol = document.getElementById(id).volume;
                currentVolume = Math.round((vol - 0.1) * 10) / 10;
                document.getElementById(id).volume = currentVolume;
                document.getElementById(id + "-vol").innerHTML = currentVolume;
            }
        }

        function playFunc(id) {
            currentPlayingId = id;
            document.getElementById("audio-top").innerHTML = id;
            document.getElementById(id).play();
            document.getElementById(id).addEventListener('timeupdate', (timeObj) => {
                document.getElementById(`${id}-time`).innerHTML = `${percentage(document.getElementById(id).currentTime, document.getElementById(id).duration).toFixed(0)}% (${currentTimeStamp(document.getElementById(id).currentTime)})`;
            })
            document.getElementById(`${id}-block`).style.backgroundColor = DARK_BLUE;
            files.forEach(file => {
                if (file != id) {
                    document.getElementById(file).pause();
                    document.getElementById(`${file}-block`).style.backgroundColor = LIGHT_BLUE;
                }
            });
        }

        function playFuncWithConfig(obj) {
            currentPlayingObj = obj;
            document.getElementById("audio-top").innerHTML = currentPlayingObj.file;
            document.getElementById(obj.file).play();
            document.getElementById(obj.file).addEventListener('timeupdate', (timeObj) => {
                document.getElementById(`${obj.file}-time`).innerHTML = `${percentage(document.getElementById(obj.file).currentTime, document.getElementById(obj.file).duration).toFixed(0)}% (${currentTimeStamp(document.getElementById(obj.file).currentTime)})`;
            })
            if (obj.tags.includes(COMBAT_TAG)) {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = DARK_COMBAT;
            } else {
                document.getElementById(`${obj.file}-block`).style.backgroundColor = DARK_BLUE;
            }
            config.forEach(file => {
                if (file.file != obj.file) {
                    document.getElementById(file.file).pause();
                    if (file.tags.includes(COMBAT_TAG)) {
                        document.getElementById(`${file.file}-block`).style.backgroundColor = LIGHT_COMBAT;
                    } else {
                        document.getElementById(`${file.file}-block`).style.backgroundColor = LIGHT_BLUE;
                    }
                }
            });
        }

        function loadAudioFileFromConfig(obj) {
            var audioBlock = document.createElement("div");
            audioBlock.className = "audio-block";
            audioBlock.id = `${obj.file}-block`;
            if (obj.tags.includes(COMBAT_TAG)) {
                audioBlock.style.backgroundColor = LIGHT_COMBAT;
            } else {
                audioBlock.style.backgroundColor = LIGHT_BLUE;
            }
            audioBlock.onclick = () => {
                playFuncWithConfig(obj);
            }

            var resetButton = document.createElement("button");
            resetButton.className = "audio-reset";
            resetButton.innerHTML = "x";
            resetButton.onclick = (e) => {
                stopPlayWithConfig(obj);
                e.stopPropagation();
            }

            var upButton = document.createElement("button");
            upButton.className = "audio-up";
            upButton.innerHTML = "^";
            upButton.onclick = (e) => {
                upVolume(obj.file);
                e.stopPropagation();
            }

            var downButton = document.createElement("button");
            downButton.className = "audio-down";
            downButton.innerHTML = "v";
            downButton.onclick = (e) => {
                downVolume(obj.file);
                e.stopPropagation();
            }

            var pauseButton = document.createElement("button");
            pauseButton.className = "audio-pause";
            pauseButton.innerHTML = "P";
            pauseButton.onclick = (e) => {
                pausePlayWithConfig(obj);
                e.stopPropagation();
            }

            var label = document.createElement("p");
            label.className = "audio-label";
            label.innerHTML = `<span id="${obj.file}-status" class="statusDiv"></span>${obj.displayName}`;

            var tags = document.createElement("div");
            tags.className = "audio-tags";
            tags.innerHTML = "";
            obj.tags.forEach(tag => {
                tags.innerHTML += `${tag}, `;
            })

            var labelTime = document.createElement("p");
            labelTime.className = "audio-time";
            labelTime.id = `${obj.file}-time`;
            labelTime.innerHTML = "0%";

            var labelVolume = document.createElement("p");
            labelVolume.className = "audio-vol";
            labelVolume.id = `${obj.file}-vol`;
            labelVolume.innerHTML = "1";

            var sound = document.createElement('audio');
            sound.id = obj.file;
            sound.className = "audio-player";
            sound.addEventListener('canplaythrough', () => {
                // console.log("LOADED: ", file);
                document.getElementById(`${obj.file}-status`).style.backgroundColor = "lightGreen";
            })
            // sound.onplay = () => {
            //     playFunc(obj.file);
            // }
            sound.onended = () => {
                document.getElementById(currentPlayingObj.file).play();
                playFuncWithConfig(currentPlayingObj);
            }
            sound.src = `audio/${obj.file}.mp3`;
            sound.type = 'audio/mp3';
            sound.onload = () => {
                // console.log("Loaded: ", file);
            }

            audioBlock.appendChild(sound);
            audioBlock.appendChild(label);
            audioBlock.appendChild(tags);
            audioBlock.appendChild(labelTime);
            audioBlock.appendChild(labelVolume);
            audioBlock.appendChild(resetButton);
            audioBlock.appendChild(upButton);
            audioBlock.appendChild(downButton);
            audioBlock.appendChild(pauseButton);
            document.getElementById("audio-container").appendChild(audioBlock);
        }

        function loadAudioFile(file) {
            var audioBlock = document.createElement("div");
            audioBlock.className = "audio-block";
            audioBlock.style.backgroundColor = LIGHT_BLUE;
            audioBlock.id = `${file}-block`;
            audioBlock.onclick = () => {
                playFunc(file);
            }

            var resetButton = document.createElement("button");
            resetButton.className = "audio-reset";
            resetButton.innerHTML = "x";
            resetButton.onclick = (e) => {
                stopPlay(file);
                e.stopPropagation();
            }

            var upButton = document.createElement("button");
            upButton.className = "audio-up";
            upButton.innerHTML = "^";
            upButton.onclick = (e) => {
                upVolume(file);
                e.stopPropagation();
            }

            var downButton = document.createElement("button");
            downButton.className = "audio-down";
            downButton.innerHTML = "v";
            downButton.onclick = (e) => {
                downVolume(file);
                e.stopPropagation();
            }

            var pauseButton = document.createElement("button");
            pauseButton.className = "audio-pause";
            pauseButton.innerHTML = "P";
            pauseButton.onclick = (e) => {
                pausePlay(file);
                e.stopPropagation();
            }

            var label = document.createElement("p");
            label.className = "audio-label";
            label.innerHTML = `<span id="${file}-status" class="statusDiv"></span>${file}`;

            var labelTime = document.createElement("p");
            labelTime.className = "audio-time";
            labelTime.id = `${file}-time`;
            labelTime.innerHTML = "0%";

            var labelVolume = document.createElement("p");
            labelVolume.className = "audio-vol";
            labelVolume.id = `${file}-vol`;
            labelVolume.innerHTML = "1";

            var sound = document.createElement('audio');
            sound.id = file;
            sound.className = "audio-player";
            sound.addEventListener('canplaythrough', () => {
                // console.log("LOADED: ", file);
                document.getElementById(`${file}-status`).style.backgroundColor = "lightGreen";
            })
            // sound.onplay = () => {
            //     playFunc(file);
            // }
            sound.onended = () => {
                document.getElementById(currentPlayingId).play();
                playFunc(currentPlayingId);
            }
            sound.src = `audio/${file}.mp3`;
            sound.type = 'audio/mp3';
            sound.onload = () => {
                // console.log("Loaded: ", file);
            }

            audioBlock.appendChild(sound);
            audioBlock.appendChild(label);
            audioBlock.appendChild(labelTime);
            audioBlock.appendChild(labelVolume);
            audioBlock.appendChild(resetButton);
            audioBlock.appendChild(upButton);
            audioBlock.appendChild(downButton);
            audioBlock.appendChild(pauseButton);
            document.getElementById("audio-container").appendChild(audioBlock);
        }

        function loaded() {
            console.log(config);

            if (config) {
                console.log("Loading from config file");
                document.getElementById("config-loaded").style.backgroundColor = "lightGreen";
                config.forEach(obj => {
                    loadAudioFileFromConfig(obj);
                });
            } else {
                files.forEach(file => {
                    loadAudioFile(file);
                });
            }
        }

    </script>
</head>

<body onload="loaded()">
    <div id="config-loaded"></div>
    <div id="audio-top"></div>
    <div id="audio-container"></div>
</body>

</html>